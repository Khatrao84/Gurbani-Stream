<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Gurbani Stream</title>
  
  <link rel="manifest" href="manifest.json">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="theme-color" content="#000000">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">

  <link rel="preconnect" href="https://www.youtube.com">
  <link rel="preconnect" href="https://www.google.com">
  <link rel="preconnect" href="https://api.rss2json.com">
  <link rel="dns-prefetch" href="https://www.youtube.com">
  <link rel="dns-prefetch" href="https://api.rss2json.com">

  <link rel="icon" href="favicon.png" type="image/png">
  <link rel="apple-touch-icon" href="favicon.png">
  
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Gurmukhi:wght@400;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
  <script src="https://www.youtube.com/iframe_api"></script>

  <style>
    /* --- CORE STYLES --- */
    html, body {
      margin: 0; padding: 0; height: 100%;
      background-color: black; font-family: "Noto Sans Gurmukhi", sans-serif;
      overflow: hidden; -webkit-tap-highlight-color: transparent; 
      user-select: none; cursor: none;
    }
    body.user-active { cursor: default; }
    
    #container { position: relative; width: 100vw; height: 100vh; }
    
    #stream { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 0; background: black; }
    #youtube-player-host { width: 100%; height: 100%; border: none; }
    .video-placeholder { width: 100%; height: 100%; background: black; }
    
    #hls-video { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; z-index: 1; display: none; }
    #audio-bg { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-position: center; background-size: cover; z-index: 1; display: none; }
    #overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 2; cursor: pointer; outline: none; }

    /* --- CHANNEL LIST SIDEBAR --- */
    #channelListOverlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 320px; 
      height: 100%;
      background: rgba(0, 0, 0, 0.75); 
      backdrop-filter: blur(15px);
      -webkit-backdrop-filter: blur(15px);
      z-index: 10;
      transform: translateX(-100%); 
      transition: transform 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      padding-top: 20px;
      padding-bottom: 20px;
      box-shadow: 5px 0 20px rgba(0,0,0,0.5);
    }
    
    #channelListOverlay.open {
      transform: translateX(0);
    }

    #channelListOverlay::-webkit-scrollbar { width: 6px; }
    #channelListOverlay::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 3px; }

    .ch-item {
      padding: 18px 25px;
      font-size: 20px;
      color: rgba(255, 255, 255, 0.85); 
      cursor: pointer;
      border-bottom: 1px solid rgba(255, 255, 255, 0.05);
      transition: all 0.2s ease;
      font-weight: 500;
      border-left: 5px solid transparent; /* Placeholder for border */
    }

    /* NAVIGATION HIGHLIGHT (Blue Box) */
    .ch-item.highlighted {
      background-color: #00296B; 
      color: #FFD700;           
      font-weight: bold;
      border-left: 5px solid #FFD700;
      padding-left: 20px; 
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    }

    /* CURRENTLY PLAYING MARKER (Subtle indication) */
    .ch-item.playing::after {
        content: '●';
        float: right;
        color: #00ff00;
        font-size: 14px;
        margin-top: 4px;
    }

    #channelName {
      position: absolute; bottom: 0; left: 0; width: 100%;
      padding: 31px 20px 10px 20px; font-size: 24px; font-weight: bold;
      text-align: center; z-index: 3; transform: translateY(0); opacity: 0;
      transition: opacity 0.5s ease; pointer-events: none; 
    }
    
     .style-main { 
        background: linear-gradient(to top, rgba(0, 41, 107, 0.9) 75%, rgba(0,41,107,0.1) 100%);
        color: #FFD700 !important; text-shadow: 2px 2px 4px black;
    }
    .style-alt { 
        background: linear-gradient(to top, rgba(255, 215, 0, 0.9) 75%, rgba(255,215,0,0.1) 100%);
        color: #00296B !important; text-shadow: none;
    }
    #channelName.show { opacity: 1; }
    
    .loading {
      position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
      width: 60px; height: 60px; border: 6px solid rgba(255, 213, 0, 0.2);
      border-radius: 50%; border-top-color: #ffd500;
      animation: spin 1s linear infinite; z-index: 4; display: none;
    }
    @keyframes spin { to { transform: translate(-50%, -50%) rotate(360deg); } }
    
    #time-tv {
      position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: none; z-index: 1; 
      background: url("haarimandr.png") no-repeat center center; background-size: cover; font-family: "Arial Black", sans-serif;
    }
    #time-tv .clock { position: absolute; top: 6%; right: 3%; font-size: 8.7vw; color: #FFD700; text-shadow: 0 0 10px #FFD700; }
    #time-tv .date { position: absolute; top: 2%; right: 3.5%; font-size: 3vw; color: #FFE066; }

    /* --- INSTALL POPUP --- */
    #installBackdrop {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0, 0, 0, 0.85); backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px); 
      z-index: 9998; display: none;
    }
    #installHelp {
      position: absolute; top: 15%; left: 50%; transform: translateX(-50%);
      width: 90%; max-width: 600px; text-align: center; color: white;
      font-family: "Arial", sans-serif; pointer-events: none;
    }
    #installHelp h3 { font-size: 22px; margin-bottom: 20px; color: #FFD700; text-transform: uppercase; letter-spacing: 1px; }
    #installHelp p { font-size: 18px; margin: 12px 0; line-height: 1.5; color: #f0f0f0; }

    #installPopup {
      position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
      background: #00296B; border: 2px solid #FFD700; border-radius: 12px;
      padding: 20px 25px; z-index: 9999; display: none; 
      box-shadow: 0 10px 30px rgba(0,0,0,0.9);
      color: white; font-family: sans-serif; text-align: center;
      width: 80%; max-width: 320px;
    }
    #installPopup p { margin: 0 0 15px 0; font-size: 18px; line-height: 1.4; }
    #installPopup button {
      background: #FFD700; color: #00296B; border: none; padding: 12px 25px;
      font-weight: bold; border-radius: 6px; cursor: pointer; font-size: 16px; width: 100%;
    }
    #installPopup .close-btn { position: absolute; top: 8px; right: 12px; color: #ccc; font-size: 20px; cursor: pointer; }
  </style>
</head>
<body>
  <div id="container">
    <div id="channelListOverlay"></div>
    <div id="stream">
      <div id="youtube-player-host"></div>
    </div>
    
    <video id="hls-video" playsinline></video>
    <audio id="bg-audio" preload="auto"></audio>
    <div id="audio-bg"></div>
    <div id="time-tv"><div class="clock"></div><div class="date"></div></div>
    
    <div id="installBackdrop">
      <div id="installHelp">
        <h3>CONTROLS</h3>
        <p>1. Single Click for Channel forward.</p>
        <p>2. Swipe in any direction for Channel backward.</p>
        <p>3. Long Press for toggle ( Channel 0-3 ).</p>
        <p>4. Green Button: Refresh App.</p>
        <p>5. Red Button: Switch Stream (Toggle).</p>
        <p>6. Yellow Button: Toggle Loop (Ch 0).</p>
        <p>7. Blue Button: Channel List.</p>
      </div>
    </div>
    
    <div id="installPopup">
      <div class="close-btn" onclick="InstallService.closePopup()">✕</div>
      <p id="installText">Install Gurbani Stream App?</p>
      <button id="installActionBtn">Install Now</button>
    </div>

    <div id="overlay" tabindex="0"></div>
    <div id="channelName" class="style-main"></div>
    <div class="loading" id="loading"></div>
  </div>

<script>
/**
 * --- CONFIGURATION ---
 */
const Config = {
  SCROLL_SPEED_MS: 350,
  AUTO_REFRESH_MS: 10800000, 
  RSS_FETCH_TIMEOUT: 5000,
  KEY_THROTTLE_MS: 300, /* Faster nav in list */
  LOCAL_AUDIO_FILE: "sukhmani.mp3",
  LOCAL_RADIO_IMG: "audioharimandar.png",
  LONG_PRESS_MS: 800,
  SWIPE_THRESHOLD: 50,
  WATCHDOG_INTERVAL: 2000, 
  MAX_RETRIES: 3,
  LIST_TIMEOUT_MS: 8000 // 8 Seconds to auto-select
};

const CHANNELS = [
  { name: "0. ਸੁਖਮਨੀ ਸਾਹਿਬ", type: "time", allowToggle: true },
  { name: "1. ਸ਼੍ਰੀ ਪਟਨਾ ਸਾਹਿਬ ਲਾਈਵ", channelId: "UC3nqw1kd4AK1q9e68YUoLDQ", fallback: "TTK7eNuI3M0", type: "direct", allowToggle: true },
  { name: "2. ਸ਼੍ਰੀ ਅੰਮ੍ਰਿਤਸਰ ਸਾਹਿਬ ਲਾਈਵ", channelId: "UCYn6UEtQ771a_OWSiNBoG8w", type: "direct-rss", allowToggle: true, isRadioHybrid: true, radioUrl: "https://live.sgpc.net:8443/;", radioImage: Config.LOCAL_RADIO_IMG },
  { name: "3. ਸ਼੍ਰੀ ਫਤੇਹਗੜ੍ਹ ਸਾਹਿਬ ਲਾਈਵ", channelId: "UCudVHqnOekwcvpzNpY8_ERw", type: "direct-rss", allowToggle: true },
  { name: "4. ਸ਼੍ਰੀ ਕੋਤਵਾਲੀ ਸਾਹਿਬ ਮੋਰਿੰਡਾ ਲਾਈਵ", channelId: "UCri5TwOgoDY3ywUDK9Ar1Lg", type: "direct" },
  { name: "5. ਸ਼੍ਰੀ ਆਨੰਦਪੁਰ ਸਾਹਿਬ ਲਾਈਵ", channelId: "UCSx5035_us8h8DOp_YhQDaw", type: "direct" },
  { name: "6. ਸ਼੍ਰੀ ਦਮਦਮਾ ਸਾਹਿਬ ਲਾਈਵ", channelId: "UCY8jMpyRRcdzSf6uLiU6izQ", type: "direct" },
  { name: "7. ਸ਼੍ਰੀ ਦੂਖ-ਨਿਵਾਰਨ ਸਾਹਿਬ ਲੁਧਿਆਣਾ ਲਾਈਵ", channelId: "UCPKPN4bzM8Ja-F_kIEZoAhA", type: "direct-rss" },
  { name: "8. ਸ਼੍ਰੀ ਦੂਖ-ਨਿਵਾਰਨ ਸਾਹਿਬ ਪਟਿਆਲਾ ਲਾਈਵ", channelId: "UC7Uf4ZOlCGM3zBCLqcNPtJg", type: "direct-rss" },
  { name: "9. ਸ਼੍ਰੀ ਬਾਬਾ ਦੀਪ ਸਿੰਘ ਜੀ ਅੰਮ੍ਰਿਤਸਰ ਲਾਈਵ", channelId: "UCxWx-MPft_7mKrFtN6uOaAA", type: "direct" },
  { name: "10. ਸ਼੍ਰੀ ਪੰਜੋਖਰਾ ਸਾਹਿਬ ਅੰਬਾਲਾ ਲਾਈਵ", channelId: "UCWd5TUzbLUe6_TWKW9vaDmQ", type: "direct" },
  { name: "11. ਸ਼੍ਰੀ ਬੰਗਲਾ ਸਾਹਿਬ ਦਿੱਲੀ ਲਾਈਵ", channelId: "UCA1Jqo-WXVuMgs4WcD5f5Yw", type: "auto-rss" },
  { name: "12. ਸ਼੍ਰੀ ਸੀਸ ਗੰਜ ਸਾਹਿਬ ਦਿੱਲੀ ਲਾਈਵ", channelId: "UCm0p8BmL4d914gBefceFxxA", type: "direct" },
  { name: "13. ਸ਼੍ਰੀ ਸਿੰਘ ਸ਼ਹੀਦਾਂ ਸਾਹਿਬ ਸੋਹਾਣਾ ਲਾਈਵ", channelId: "UCflFRcHHT8Ab7AvjvIVcrQA", type: "direct" },
  { name: "14. ਸ਼੍ਰੀ ਹਜ਼ੂਰ ਸਾਹਿਬ ਲਾਈਵ", channelId: "UCuerQ47I9Y2qxr4eIopxbYw", type: "direct" }
];

function getInitialChannel() {
  const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
  if (isMobile) return 0;
  const saved = parseInt(localStorage.getItem('currentChannel'));
  return isNaN(saved) ? 0 : saved;
}

const UI = {
  container: document.getElementById('container'),
  stream: document.getElementById('stream'),
  hlsVideo: document.getElementById('hls-video'),
  timeTv: document.getElementById('time-tv'),
  audioBg: document.getElementById('audio-bg'),
  channelName: document.getElementById('channelName'),
  loading: document.getElementById('loading'),
  overlay: document.getElementById('overlay'),
  bgAudio: document.getElementById('bg-audio'),
  clock: document.querySelector('#time-tv .clock'),
  date: document.querySelector('#time-tv .date'),
  channelList: document.getElementById('channelListOverlay'),
  installPopup: document.getElementById('installPopup'),
  installBackdrop: document.getElementById('installBackdrop'),
  installText: document.getElementById('installText'),
  installBtn: document.getElementById('installActionBtn')
};

const DataService = {
  async fetchRSS(channelId, offset = 0) {
    const controller = new AbortController();
    const timeout = setTimeout(() => controller.abort(), Config.RSS_FETCH_TIMEOUT);
    try {
      const url = `https://api.rss2json.com/v1/api.json?rss_url=${encodeURIComponent('https://www.youtube.com/feeds/videos.xml?channel_id=' + channelId)}&t=${Date.now()}`;
      const res = await fetch(url, { signal: controller.signal });
      clearTimeout(timeout);
      if (!res.ok) throw new Error("RSS Error");
      const data = await res.json();
      if (data.items && data.items.length > offset) return data.items[offset].link.split('v=')[1];
      return null;
    } catch (e) { return null; }
  }
};

const YTPlayerManager = {
  player: null, isReady: false, currentVideoId: null, retryCount: 0, watchdogTimer: null, healthCheckFailures: 0,
  init() {
    window.onYouTubeIframeAPIReady = () => {
      this.player = new YT.Player('youtube-player-host', {
        height: '100%', width: '100%',
        playerVars: { autoplay: 1, controls: 0, rel: 0, modestbranding: 1, iv_load_policy: 3, fs: 0, origin: window.location.origin },
        events: { 'onReady': () => { this.isReady = true; this.onPlayerReady(); }, 'onStateChange': (e) => this.onStateChange(e), 'onError': (e) => this.onError(e) }
      });
    };
    this.startWatchdog();
  },
  onPlayerReady() { if (this.currentVideoId) this.loadVideo(this.currentVideoId, true); },
  loadVideo(videoId, isLive) {
    this.currentVideoId = videoId; this.retryCount = 0; this.healthCheckFailures = 0;
    UI.loading.style.display = 'block'; UI.stream.style.display = 'block'; UI.stream.style.opacity = '1';
    if (!this.isReady || !this.player) { console.log("Player not ready"); return; }
    try {
      if (isLive) this.player.loadVideoById({videoId: videoId}); else this.player.loadVideoById(videoId);
      this.player.unMute();
    } catch(e) { this.retryVideo(); }
  },
  onStateChange(event) {
    if (event.data === YT.PlayerState.PLAYING) { UI.loading.style.display = 'none'; this.healthCheckFailures = 0; }
    else if (event.data === YT.PlayerState.BUFFERING) UI.loading.style.display = 'block';
    else if (event.data === YT.PlayerState.ENDED) App.handleVideoEnd();
  },
  onError(event) { this.retryVideo(); },
  retryVideo() {
    if (this.retryCount < Config.MAX_RETRIES) {
      this.retryCount++; setTimeout(() => { if (this.currentVideoId && this.player) this.player.loadVideoById(this.currentVideoId); }, 1000 * this.retryCount);
    } else { App.handleVideoError(); }
  },
  startWatchdog() {
    clearInterval(this.watchdogTimer);
    this.watchdogTimer = setInterval(() => {
      if (!this.player || !this.isReady || UI.stream.style.display === 'none') return;
      const state = this.player.getPlayerState();
      if (state === YT.PlayerState.BUFFERING || state === -1) this.healthCheckFailures++; else this.healthCheckFailures = 0;
      if (this.healthCheckFailures > 4) { this.healthCheckFailures = 0; if (this.currentVideoId) this.player.loadVideoById(this.currentVideoId); }
    }, Config.WATCHDOG_INTERVAL);
  },
  hide() { if (this.player && typeof this.player.stopVideo === 'function') try { this.player.stopVideo(); } catch(e){} UI.stream.style.display = 'none'; }
};

const AppState = { 
  currentChannel: getInitialChannel(), 
  streamToggle: 0, 
  loadSequence: 0, 
  lastScrollTime: Date.now() + 2000, 
  timers: { load: null, banner: null, list: null }, 
  suppressClick: false, 
  isListOpen: false,
  navigatedIndex: 0 // Tracks Blue Box position
};

const App = {
  init() {
    YTPlayerManager.init(); InstallService.init(); SystemService.init();
    this.renderChannelList(); 
    this.setupInputs(); this.setupClock(); this.loadChannel(AppState.currentChannel, 0);
    setTimeout(() => window.location.reload(), Config.AUTO_REFRESH_MS);
  },

  // --- CHANNEL LIST LOGIC ---
  renderChannelList() {
    UI.channelList.innerHTML = ''; 
    CHANNELS.forEach((ch, index) => {
      const el = document.createElement('div');
      el.className = 'ch-item';
      if (index === AppState.currentChannel) el.classList.add('playing'); // Green Dot
      if (index === AppState.navigatedIndex) el.classList.add('highlighted'); // Blue Box
      el.textContent = ch.name;
      el.onclick = (e) => { 
        e.stopPropagation(); 
        AppState.navigatedIndex = index;
        this.confirmSelection();
      };
      UI.channelList.appendChild(el);
    });
  },

  updateListVisuals() {
     const items = document.querySelectorAll('.ch-item');
     items.forEach((el, index) => {
         el.classList.remove('highlighted');
         el.classList.remove('playing');
         
         if (index === AppState.navigatedIndex) {
            el.classList.add('highlighted'); // Blue Box
            if (AppState.isListOpen) el.scrollIntoView({block: 'nearest', behavior: 'smooth'});
         }
         if (index === AppState.currentChannel) {
            el.classList.add('playing'); // Green Dot
         }
     });
  },

  toggleList() {
     if (AppState.isListOpen) {
        // Closing manually -> Confirm Selection
        this.confirmSelection();
     } else {
        // Opening
        AppState.isListOpen = true;
        AppState.navigatedIndex = AppState.currentChannel; // Start highlight at current
        this.updateListVisuals();
        UI.channelList.classList.add('open');
        this.resetListTimer();
     }
  },

  navigateList(dir) {
     const len = CHANNELS.length;
     AppState.navigatedIndex = (AppState.navigatedIndex + dir + len) % len;
     this.updateListVisuals();
     this.resetListTimer(); // Keep list alive while moving
  },

  resetListTimer() {
     clearTimeout(AppState.timers.list);
     AppState.timers.list = setTimeout(() => {
         // Time out -> Auto Select
         if (AppState.isListOpen) {
             console.log("List Timeout: Auto-selecting channel");
             this.confirmSelection();
         }
     }, Config.LIST_TIMEOUT_MS);
  },

  confirmSelection() {
     AppState.isListOpen = false;
     UI.channelList.classList.remove('open');
     clearTimeout(AppState.timers.list);
     
     // Switch to whatever the Blue Box was on
     if (AppState.navigatedIndex !== AppState.currentChannel) {
        this.triggerChannelLoad(AppState.navigatedIndex);
     }
  },
  // --------------------------------

  handleVideoEnd() { const channel = CHANNELS[AppState.currentChannel]; if (channel && channel.fallback) YTPlayerManager.loadVideo(channel.fallback, false); },
  handleVideoError() { const channel = CHANNELS[AppState.currentChannel]; if (channel && channel.fallback && YTPlayerManager.currentVideoId !== channel.fallback) YTPlayerManager.loadVideo(channel.fallback, false); else UI.loading.style.display = 'none'; },
  setupClock() {
    const update = () => {
      const now = new Date(); UI.clock.textContent = now.toLocaleTimeString('en-US', { hour12: true });
      UI.date.textContent = now.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
    };
    setInterval(update, 1000); update();
  },
  setupInputs() {
    let cursorTimeout;
    const wakeUI = () => { document.body.classList.add('user-active'); clearTimeout(cursorTimeout); cursorTimeout = setTimeout(() => document.body.classList.remove('user-active'), 3000); };
    window.addEventListener('mousemove', wakeUI); window.addEventListener('click', wakeUI);
    window.addEventListener('wheel', (e) => {
        if (AppState.isListOpen) return; // Disable scroll if list open
        if (Math.abs(e.deltaY) < 10) return; const now = Date.now();
        if (now - AppState.lastScrollTime < Config.KEY_THROTTLE_MS) return; AppState.lastScrollTime = now;
        this.changeChannel(-1);
    });
    window.addEventListener('mousedown', (e) => { if (e.button === 1) { e.preventDefault(); this.triggerChannelLoad(AppState.currentChannel); } });
    
    // Touch Logic
    let touchStartX = 0; let touchStartY = 0; let pressTimer = null;
    UI.overlay.addEventListener('touchstart', (e) => {
        if (e.touches.length > 1) return; touchStartX = e.touches[0].clientX; touchStartY = e.touches[0].clientY;
        AppState.suppressClick = false; pressTimer = setTimeout(() => { AppState.suppressClick = true; this.triggerChannelLoad(AppState.currentChannel); if (navigator.vibrate) navigator.vibrate(50); }, Config.LONG_PRESS_MS);
    }, {passive: true});
    UI.overlay.addEventListener('touchmove', (e) => { if (Math.abs(e.touches[0].clientX - touchStartX) > 10 || Math.abs(e.touches[0].clientY - touchStartY) > 10) clearTimeout(pressTimer); }, {passive: true});
    UI.overlay.addEventListener('touchend', (e) => {
        clearTimeout(pressTimer); if (AppState.suppressClick) return; 
        if (Math.abs(e.changedTouches[0].clientX - touchStartX) > Config.SWIPE_THRESHOLD || Math.abs(e.changedTouches[0].clientY - touchStartY) > Config.SWIPE_THRESHOLD) { AppState.suppressClick = true; this.changeChannel(-1); }
    });
    UI.overlay.addEventListener('click', (e) => { 
        if (AppState.isListOpen) { this.toggleList(); return; } // Close list on click
        if (AppState.suppressClick) { AppState.suppressClick = false; e.stopImmediatePropagation(); return; } 
        this.changeChannel(1); 
    });

    let keyBuffer = ""; let bufferTimer = null;
    window.addEventListener('keydown', (e) => {
      const k = e.key; const c = e.keyCode; const now = Date.now();
      
      if (k === 'ColorF1Green' || c === 404 || k === 'Green') { e.preventDefault(); window.location.reload(); return; }
      if (k === 'ColorF0Red' || c === 403 || k === 'Red') { e.preventDefault(); this.triggerChannelLoad(AppState.currentChannel); return; }
      if (k === 'ColorF2Yellow' || c === 405 || k === 'Yellow') {
         e.preventDefault();
         if (AppState.currentChannel === 0) { UI.bgAudio.loop = !UI.bgAudio.loop; this.showBanner(UI.bgAudio.loop ? "Loop Mode: ON" : "Loop Mode: OFF", UI.bgAudio.loop ? 1 : 0); } 
         else { this.showBanner("Loop Available on Ch 0 Only", 0); }
         return;
      }
      
      // BLUE BUTTON LIST TOGGLE
      if (k === 'ColorF3Blue' || c === 406 || k === 'Blue') {
         e.preventDefault();
         this.toggleList();
         return;
      }

      if (!/^[0-9]$/.test(k)) { if (now - AppState.lastScrollTime < Config.KEY_THROTTLE_MS) return; AppState.lastScrollTime = now; }
      wakeUI();

      // NAV KEYS
      const isUp = (k === "ArrowRight" || k === "ArrowUp" || k === "ChannelUp" || c === 427 || k === "PageUp" || c === 33);
      const isDown = (k === "ArrowLeft" || k === "ArrowDown" || k === "ChannelDown" || c === 428 || k === "PageDown" || c === 34);

      if (isUp || isDown) {
          e.preventDefault();
          if (AppState.isListOpen) {
              // NAVIGATION IN LIST MODE
              this.navigateList(isUp ? 1 : -1);
          } else {
              // NORMAL CHANNEL CHANGE
              this.changeChannel(isUp ? 1 : -1);
          }
          return;
      }

      // NUMBER KEYS
      if (/^[0-9]$/.test(k)) {
        e.preventDefault(); keyBuffer += k; clearTimeout(bufferTimer);
        bufferTimer = setTimeout(() => {
            const num = parseInt(keyBuffer, 10); keyBuffer = "";
            let targetIndex = (num === 0) ? CHANNELS.findIndex(ch => ch.name.startsWith("0.")) : CHANNELS.findIndex(ch => ch.name.startsWith(num + "."));
            if (targetIndex !== -1) { 
               if(AppState.isListOpen) {
                  // If list open, just highlight, don't load yet
                  AppState.navigatedIndex = targetIndex;
                  this.updateListVisuals();
                  this.resetListTimer();
               } else {
                  this.triggerChannelLoad(targetIndex); 
               }
            }
        }, 1200); 
      }
    });
  },
  changeChannel(dir) { const newIdx = (AppState.currentChannel + dir + CHANNELS.length) % CHANNELS.length; this.triggerChannelLoad(newIdx); },
  triggerChannelLoad(index) {
    const isSame = (AppState.currentChannel === index); const channel = CHANNELS[index];
    if (isSame && channel.type === 'time') { this.toggleCh0Audio(); return; }
    if (isSame && channel.allowToggle) AppState.streamToggle = (AppState.streamToggle === 0) ? 1 : 0; else AppState.streamToggle = 0;
    
    AppState.currentChannel = index; 
    AppState.navigatedIndex = index; // Sync highlight
    localStorage.setItem('currentChannel', index); 
    this.showBanner(channel.name, AppState.streamToggle);
    this.updateListVisuals(); // Update Green Dot

    clearTimeout(AppState.timers.load); AppState.loadSequence++; const currentSeq = AppState.loadSequence;
    AppState.timers.load = setTimeout(() => { if (currentSeq === AppState.loadSequence) this.loadChannel(index, AppState.streamToggle); }, Config.SCROLL_SPEED_MS);
  },
  toggleCh0Audio() { if (UI.bgAudio.paused) UI.bgAudio.play().then(() => this.showBanner("0. ਸੁਖਮਨੀ ਸਾਹਿਬ (Playing)", 1)).catch(() => this.showBanner("Error: Audio Blocked", 0)); else { UI.bgAudio.pause(); this.showBanner("0. ਸੁਖਮਨੀ ਸਾਹਿਬ (Paused)", 0); } },
  showBanner(name, mode) { UI.channelName.textContent = name; UI.channelName.className = (mode === 1) ? 'style-alt show' : 'style-main show'; clearTimeout(AppState.timers.banner); AppState.timers.banner = setTimeout(() => UI.channelName.classList.remove("show"), 3000); },
  async loadChannel(index, toggle) {
    const channel = CHANNELS[index]; const currentSeq = AppState.loadSequence;
    UI.loading.style.display = 'block'; UI.timeTv.style.display = 'none'; UI.audioBg.style.display = 'none'; UI.bgAudio.pause();
    if (channel.type === 'time') { 
        YTPlayerManager.hide(); 
        UI.timeTv.style.display = 'block'; 
        UI.loading.style.display = 'none'; 
        UI.bgAudio.loop = false; 
        UI.bgAudio.src = Config.LOCAL_AUDIO_FILE; 
        UI.bgAudio.currentTime = 0; 
        UI.bgAudio.play().catch(e=>{}); 
        this.showBanner(channel.name, 0); 
        return; 
    }
    if (channel.isRadioHybrid && toggle === 1) { YTPlayerManager.hide(); UI.audioBg.style.backgroundImage = `url('${channel.radioImage}')`; UI.audioBg.style.display = 'block'; UI.loading.style.display = 'none'; UI.bgAudio.src = channel.radioUrl; UI.bgAudio.play().catch(e => console.warn(e)); this.showBanner(channel.name, 1); return; }
    
    const isAlt = (toggle === 1); let videoId = null; let isLive = true;
    try {
      if (channel.type === 'direct-rss' || channel.type === 'auto-rss' || channel.type === 'hybrid') {
         if ((channel.type === 'direct-rss' && toggle === 1) || (channel.type === 'auto-rss') || (channel.type === 'hybrid' && isAlt)) { videoId = await DataService.fetchRSS(channel.channelId, isAlt ? 1 : 0); isLive = false; }
      }
      if (!videoId) { if (channel.type === 'direct' && toggle === 1 && channel.fallback) { videoId = channel.fallback; isLive = false; } else videoId = channel.channelId; }
      if (currentSeq !== AppState.loadSequence) return;
      YTPlayerManager.loadVideo(videoId || channel.channelId, isLive);
    } catch (e) { if (channel.fallback) YTPlayerManager.loadVideo(channel.fallback, false); }
  }
};

const OriginalLoad = YTPlayerManager.loadVideo;
YTPlayerManager.loadVideo = function(id, isLive) {
  if (id.startsWith('UC')) {
     const embedUrl = `https://www.youtube.com/embed/live_stream?channel=${id}&autoplay=1&mute=0&controls=0&enablejsapi=1&origin=${window.location.origin}`;
     const currentSrc = this.player ? this.player.getIframe().src : '';
     if (!currentSrc.includes(id)) { this.player.getIframe().src = embedUrl; }
     UI.loading.style.display = 'block'; UI.stream.style.display = 'block';
  } else {
     const currentSrc = this.player ? this.player.getIframe().src : '';
     if (currentSrc.includes('live_stream?channel=')) { this.player.getIframe().src = `https://www.youtube.com/embed/${id}?autoplay=1&mute=0&controls=0&enablejsapi=1&origin=${window.location.origin}`; } 
     else { OriginalLoad.call(this, id, isLive); }
  }
};

const InstallService = { deferredPrompt: null, init() { if ('serviceWorker' in navigator) navigator.serviceWorker.register('sw.js'); window.addEventListener('beforeinstallprompt', (e) => { e.preventDefault(); this.deferredPrompt = e; UI.installBackdrop.style.display = 'block'; UI.installPopup.style.display = 'block'; }); }, closePopup() { UI.installPopup.style.display = 'none'; UI.installBackdrop.style.display = 'none'; } };
UI.installBtn.onclick = () => { if (InstallService.deferredPrompt) { InstallService.deferredPrompt.prompt(); InstallService.deferredPrompt.userChoice.then(() => InstallService.closePopup()); } };
const SystemService = { init() { if ('wakeLock' in navigator) { const req = async () => { try { await navigator.wakeLock.request('screen'); } catch(e){} }; document.addEventListener('visibilitychange', () => { if (document.visibilityState === 'visible') req(); }); req(); } } };

App.init(); 
</script>
</body>
</html>
